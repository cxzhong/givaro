name: CI Build and Test

on:
  push:
    branches: 
      - master
  workflow_dispatch:

jobs:
  build-ubuntu-gcc:
    name: Ubuntu with GCC
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential autoconf automake libtool \
                                pkg-config m4 libgmp-dev libgmpxx4ldbl
    
    - name: Configure
      run: |
        autoreconf -vif
        mkdir -p build-gcc
        cd build-gcc
        ../configure CC=gcc CXX=g++
    
    - name: Build
      run: |
        cd build-gcc
        make -j$(nproc)
    
    - name: Test
      run: |
        cd build-gcc
        make check
    
    - name: Display test results
      if: always()
      run: |
        cd build-gcc/tests
        if [ -f test-suite.log ]; then
          echo "=== Test Suite Summary ==="
          tail -100 test-suite.log
        fi

  build-ubuntu-clang:
    name: Ubuntu with Clang + libc++
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential autoconf automake libtool \
                                pkg-config m4 libgmp-dev libgmpxx4ldbl \
                                clang libc++-dev libc++abi-dev
    
    - name: Configure
      run: |
        autoreconf -vif
        mkdir -p build-clang
        cd build-clang
        ../configure CC=clang CXX=clang++ \
                     CXXFLAGS="-stdlib=libc++ -D__GIVARO_GMP_NO_CXX" \
                     LDFLAGS="-stdlib=libc++"
    
    - name: Build
      run: |
        cd build-clang
        make -j$(nproc)
    
    - name: Test
      run: |
        cd build-clang
        make check
    
    - name: Display test results
      if: always()
      run: |
        cd build-clang/tests
        if [ -f test-suite.log ]; then
          echo "=== Test Suite Summary ==="
          tail -100 test-suite.log
        fi

  build-macos-clang:
    name: macOS with LLVM/Clang
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        brew install autoconf automake libtool pkg-config gmp llvm
    
    - name: Configure
      run: |
        autoreconf -vif
        mkdir -p build-macos
        cd build-macos
        # Set paths for Homebrew-installed GMP and LLVM
        GMP_PREFIX=$(brew --prefix gmp)
        LLVM_PREFIX=$(brew --prefix llvm)
        export PATH="${LLVM_PREFIX}/bin:$PATH"
        export CC="${LLVM_PREFIX}/bin/clang"
        export CXX="${LLVM_PREFIX}/bin/clang++"
        ../configure CC="${CC}" \
                     CXX="${CXX}" \
                     CPPFLAGS="-I${GMP_PREFIX}/include" \
                     LDFLAGS="-L${GMP_PREFIX}/lib -L${LLVM_PREFIX}/lib/c++ -Wl,-rpath,${LLVM_PREFIX}/lib/c++ -stdlib=libc++" \
                     CXXFLAGS="-stdlib=libc++"
    
    - name: Build
      run: |
        LLVM_PREFIX=$(brew --prefix llvm)
        export PATH="${LLVM_PREFIX}/bin:$PATH"
        export CC="${LLVM_PREFIX}/bin/clang"
        export CXX="${LLVM_PREFIX}/bin/clang++"
        cd build-macos
        make -j$(sysctl -n hw.ncpu)
    
    - name: Test
      run: |
        LLVM_PREFIX=$(brew --prefix llvm)
        export PATH="${LLVM_PREFIX}/bin:$PATH"
        export CC="${LLVM_PREFIX}/bin/clang"
        export CXX="${LLVM_PREFIX}/bin/clang++"
        cd build-macos
        make check
    
    - name: Display test results
      if: always()
      run: |
        cd build-macos/tests
        if [ -f test-suite.log ]; then
          echo "=== Test Suite Summary ==="
          tail -100 test-suite.log
        fi
